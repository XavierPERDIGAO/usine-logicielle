---
- name: Ajout du groupe sonar
  group: name="{{sonar.group}}"

- name: Ajout de l'utilisateur sonar
  user:
    name="{{sonar.owner}}"
    group="{{sonar.group}}"
    home="{{sonar.base_dir}}"
    shell="/bin/bash"
    comment="Sonar User"

- name: Vérification de la présence de SonarQube
  stat: path="{{sonar.base_dir}}/{{sonar.name}}"
  register: sonar_install
    
- name: Téléchargement de SonarQube
  get_url: url="http://downloads.sonarsource.com/sonarqube/{{sonar.archive}}" dest="/tmp/{{sonar.archive}}"
  when: not sonar_install.stat.exists

- name: Creation du home SonaQube
  file:
    dest="{{sonar.base_dir}}"
    state=directory
    owner="{{sonar.owner}}"
    group="{{sonar.group}}"
  when: not sonar_install.stat.exists

- name: Extraction de l'archive
  unarchive:
    src="/tmp/{{sonar.archive}}"
    dest="{{sonar.base_dir}}/"
    owner="{{sonar.owner}}"
    group="{{sonar.group}}"
    copy=no
    creates="{{sonar.base_dir}}/{{sonar.name}}/bin"
  sudo_user: "{{sonar.owner}}"
  when: not sonar_install.stat.exists

- name: Création d'un lien symbolique SonaQube
  file:
    src="{{sonar.base_dir}}/{{sonar.name}}"
    dest="{{sonar.base_dir}}/sonar"
    state=link
    owner="{{sonar.owner}}"
    group="{{sonar.group}}"
  when: not sonar_install.stat.exists

- name: Installation du fichier de configuration de SonarQube
  template:
    src=templates/sonar.properties.j2
    dest="{{sonar.base_dir}}/{{sonar.name}}/conf/sonar.properties"

- name: Installation du script d'init de SonarQube
  sudo: yes
  file:
    src="{{sonar.base_dir}}/{{sonar.name}}/bin/linux-x86-{{ansible_userspace_bits}}/sonar.sh"
    dest="/etc/init.d/sonar"
    state=link
    mode=0755
    owner="root"
    group="root"

- name: Démarrage de SonarQube
  service: name=sonar state=started enabled=yes